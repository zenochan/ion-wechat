!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("@angular/platform-browser"),require("@ionic/storage"),require("@ionic/angular"),require("vconsole")):"function"==typeof define&&define.amd?define("ion-wechat",["exports","@angular/core","rxjs","@angular/platform-browser","@ionic/storage","@ionic/angular","vconsole"],t):t((e=e||self)["ion-wechat"]={},e.ng.core,e.rxjs,e.ng.platformBrowser,e.storage,e.angular,e.VConsole)}(this,function(e,t,n,r,o,i,s){"use strict";function a(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return s}function u(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}var l=function(){function e(){}return e.prototype.transform=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return new n.Observable(function(t){var n=new FileReader;n.onload=function(e){var n=e.target.result;t.next(n),t.complete()},n.readAsDataURL(e)})},e.decorators=[{type:t.Pipe,args:[{name:"preview"}]}],e}(),p=function(){function e(e){this.sanitiser=e,this.SecurityContextMap={NONE:0,HTML:1,STYLE:2,SCRIPT:3,URL:4,RESOURCE_URL:5}}return e.prototype.transform=function(e,t){var n;e+="";var r=this.SecurityContextMap.STYLE;switch(t&&"string"==typeof t&&this.SecurityContextMap.hasOwnProperty(t.toUpperCase())&&(r=this.SecurityContextMap[t.toUpperCase()]),r){case this.SecurityContextMap.HTML:n=this.sanitiser.bypassSecurityTrustHtml(e);break;case this.SecurityContextMap.URL:n=this.sanitiser.bypassSecurityTrustUrl(e);break;case this.SecurityContextMap.SCRIPT:n=this.sanitiser.bypassSecurityTrustScript(e);break;case this.SecurityContextMap.STYLE:n=this.sanitiser.bypassSecurityTrustStyle(e);break;case this.SecurityContextMap.RESOURCE_URL:n=this.sanitiser.bypassSecurityTrustResourceUrl(e);break;default:n=this.sanitiser.sanitize(r,e)}return n},e.decorators=[{type:t.Pipe,args:[{name:"sanitizer"}]},{type:t.Injectable}],e.ctorParameters=function(){return[{type:r.DomSanitizer}]},e}();Date.prototype.ONE_DAY=864e5,Date.prototype.weekOfYear=function(){var e=this.getFullYear(),t=new Date(this);t.setHours(0,0,0,0);var n=new Date(e,0,1);t.setDate(t.getDate()+n.getDay());var r=(t.getTime()-n.getTime())/this.ONE_DAY+1;return[e,Math.ceil(r/7)]},Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),/(E+)/.test(e)){e=e.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"星期":"周":"")+["日","一","二","三","四","五","六"][this.getDay()+""])}for(var n in t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e},Date.prototype.addDay=function(e){return this.setTime(this.getTime()+this.ONE_DAY*e),this};var d=function(){function e(){}return e.prototype.transform=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return e&&"string"==typeof e?((e.indexOf("1970-01-01")>-1||e.indexOf("0000-00-00")>-1)&&(e=null),e?(8===e.length&&2===e.indexOf(":")&&5===e.lastIndexOf(":")&&(e="2018/1/1 "+e),e=e.replace(/-/g,"/"),new Date(Date.parse(e)).format(t[0]||"yyyy/MM/dd")):t[1]||""):""},e.decorators=[{type:t.Pipe,args:[{name:"zdate"}]}],e}(),f=function(){function e(e){this.el=e}return e.prototype.transform=function(e,t,n){return h(e,t,n)},e.BASE_URL="",e.decorators=[{type:t.Pipe,args:[{name:"photo"}]}],e.ctorParameters=function(){return[{type:t.ElementRef}]},e}();function h(e,t,n){if(!e)return"";var r=e+"";if(0===r.indexOf("http"))return r;var o=f.BASE_URL+r;return t&&(o+="?imageView2/2/w/"+t,n&&(o+="/h/"+n)),o}var g=[l,p,d,f],m=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:u(g),imports:[],exports:u(g)}]}],e}(),E=document.createElement("script");E.src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js",document.getElementsByTagName("head")[0].appendChild(E);var y=function(){function e(){}return e.configSigner=function(t){this.signer=t,this.sign().then(function(){e.hideMenuItems.apply(e,u(e.HIDES))}).catch(function(e){return console.error("JS SDK 签名异常",e)})},e.getAuthCode=function(){var t=localStorage.getItem(e.COOKIE_KEY_AUTH_STATE);localStorage.removeItem(e.COOKIE_KEY_AUTH_STATE);var n=e.getUrlParam("state");return n&&n===t?e.getUrlParam("code"):null},e.onShareWechat=function(e){return-1===e.imgUrl.indexOf("http")&&(e.imgUrl=location.href.split("?")[0]+e.imgUrl),this.sign().catch(function(e){return console.log("jssdk 签名失败",e)}).then(function(){return new Promise(function(t){wx.onMenuShareTimeline({title:e.title+(e.desc?" | "+e.desc:""),desc:null,link:e.link,imgUrl:e.imgUrl,success:function(){return t(1)}}),wx.onMenuShareAppMessage({title:e.title,desc:e.desc,link:e.link,imgUrl:e.imgUrl,type:"link",dataUrl:null,success:function(){return t(0)}})})})},e.pay=function(t){return t.timestamp=t.timestamp||t.timeStamp,new Promise(function(n,r){t.success=function(e){"chooseWXPay:ok"===e.errMsg||"get_brand_wcpay_request:ok"===e.err_msg?n("success"):"get_brand_wcpay_request:cancel"===e.err_msg?r({code:1,message:"取消支付"}):"get_brand_wcpay_request:failed"===e.err_msg?r({code:2,message:"支付失败"}):3===e.err_code?r({code:3,message:e}):r({code:9,message:e.errMsg||e.err_msg})},t.fail=function(e){e.errMsg?r({code:9,message:e.errMsg||e.err_msg}):r(e)},e.payOld(t)})},e.payOld=function(e){var t=function(){return WeixinJSBridge.invoke("getBrandWCPayRequest",e,e.success)};"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t),document.attachEvent("onWeixinJSBridgeReady",t)):t()},e.shareUrl=function(e){var t=location.href.split("?")[0];return Object.keys(e).forEach(function(n,r){e[n]&&"null"!==e[n]&&(t+=-1===t.indexOf("?")?"?":"&",t+=n+"="+decodeURIComponent(e[n]))}),t},e.code=function(t){var r=this;return n.Observable.create(function(n){var o=r.getAuthCode();if(o)n.next(o),n.complete();else{var i=t||{};i.scope=i.scope||"snsapi_userinfo",i.state="wechat_auth_"+(new Date).getTime(),i.redirect_uri=encodeURIComponent(t.redirect_uri||location.href.split("?")[0]),i.response_type="code",localStorage.setItem(e.COOKIE_KEY_AUTH_STATE,i.state);var s=t.proxy||"https://open.weixin.qq.com/connect/oauth2/authorize";s+="?"+Object.keys(i).map(function(e){return e+"="+i[e]}).join("&")+"#wechat_redirect",window.location.replace(s),n.complete()}})},e.getNetworkType=function(){return this.sign().then(function(e){return new Promise(function(e,t){wx.getNetworkType({success:e,fail:t})})})},e.getLocation=function(){return new Promise(function(e,t){wx.getLocation({type:"gcj02",success:e,fail:t})})},e.openLocation=function(e){wx.openLocation({latitude:e.latitude,longitude:e.longitude,name:"",address:"",scale:14,infoUrl:""})},e.openAddress=function(){return this.sign().then(function(){return new Promise(function(e,t){return wx.openAddress({success:e,fail:t})})})},e.previewImage=function(e,t){e&&0!==e.length&&wx.previewImage({current:t||"",urls:e})},e.closeWindow=function(){"undefined"!=typeof wx&&wx&&wx.closeWindow(),location.href="about:blank",window.close()},e.scanQRCode=function(){var e=this;return new Promise(function(t,n){e.sign().then(function(){wx.scanQRCode({needResult:1,scanType:["qrCode","barCode"],success:function(e){return t(e.resultStr)}})}).catch(n)})},e.hideMenuItems=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.sign().then(function(){return wx.hideMenuItems({menuList:e})}).catch(function(e){return console.log(e)})},e.showMenuItems=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.sign().then(function(){return wx.showMenuItems({menuList:e})}).catch(function(e){return console.log(e)})},e.isWechatAgent=function(){var e=navigator.userAgent.toLowerCase().match(/MicroMessenger/i);return e&&"micromessenger"===e[0]||!1},e.getUrlParam=function(e,t){var n,r;void 0===t&&(t=null);var o={},i=(t?t.split("?")[1]||"":window.location.search.substring(1)).split("&");try{for(var s=a(i),c=s.next();!c.done;c=s.next()){var u=c.value.split("=");void 0===o[u[0]]?o[u[0]]=u[1]:"string"==typeof o[u[0]]?o[u[0]]=[o[u[0]],u[1]]:o[u[0]].push(u[1])}}catch(e){n={error:e}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}var l=o[e]||null;return"null"===l&&(l=null),l},e.sign=function(){var t=this;return new Promise(function(n,r){e.initialized?n():t.signer().then(function(o){o.jsApiList=e.API_LIST,o.debug=e.DEBUG,wx.config(o),wx.ready(function(){t.initialized=!0,n()}),wx.error(function(){console.error("jssdk config error"),r("jssdk config error")})}).catch(function(e){console.error("["+new Date+"][WECHAT]",e)})})},e.startRecord=function(){return wx.startRecord(),this.onVoiceRecordEnd()},e.stopRecord=function(){return n.Observable.create(function(e){wx.stopRecord({success:function(t){e.next(t.localId),e.complete()}})})},e.home=function(e){window.open("https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz="+e+"&scene=116#wechat_redirect")},e.onVoiceRecordEnd=function(){return n.Observable.create(function(e){wx.onVoiceRecordEnd({fail:function(t){e.error(t.errMsg)},complete:function(t){e.next(t.localId),e.complete()}})})},e.translateVoice=function(e){return new n.Observable(function(t){wx.translateVoice({localId:e,isShowProgressTips:1,success:function(e){t.next(e.translateResult),t.complete()}})})},e.DEBUG=!1,e.initialized=!1,e.COOKIE_KEY_AUTH_STATE="cookie_auth_state",e.API_LIST=["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","startRecord","stopRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard","openAddress"],e.MENU_ITEMS={EXPOSE_ARTICLE:"menuItem:exposeArticle",SET_FONT:"menuItem:setFont",DAY_MODE:"menuItem:dayMode",NIGHT_MODE:"menuItem:nightMode",REFRESH:"menuItem:refresh",PROFILE:"menuItem:profile",ADD_CONTACT:"menuItem:addContact",SHARE_APP_MESSAGE:"menuItem:share:appMessage",SHARE_TIME_LINE:"menuItem:share:timeline",SHARE_QQ:"menuItem:share:qq",SHARE_WEIBO_APP:"menuItem:share:weiboApp",SHARE_FACEBOOK:"menuItem:share:facebook",SHARE_QZONE:"menuItem:share:QZone",FAVORITE:"menuItem:favorite",EDIT_TAG:"menuItem:editTag",DELETE:"menuItem:delete",COPY_URL:"menuItem:copyUrl",ORIGIN_PAGE:"menuItem:originPage",READ_MORE:"menuItem:readMode",OPEN_WITH_QQ_BROWSER:"menuItem:openWithQQBrowser",OPEN_WITH_SAFARI:"menuItem:openWithSafari",SHARE_EMAIL:"menuItem:share:email",SHARE_BRAND:"menuItem:share:brand"},e.HIDES=[e.MENU_ITEMS.SHARE_QQ,e.MENU_ITEMS.SHARE_WEIBO_APP,e.MENU_ITEMS.SHARE_FACEBOOK,e.MENU_ITEMS.SHARE_QZONE,e.MENU_ITEMS.EDIT_TAG,e.MENU_ITEMS.DELETE,e.MENU_ITEMS.COPY_URL,e.MENU_ITEMS.ORIGIN_PAGE,e.MENU_ITEMS.READ_MORE,e.MENU_ITEMS.OPEN_WITH_QQ_BROWSER,e.MENU_ITEMS.OPEN_WITH_SAFARI,e.MENU_ITEMS.SHARE_EMAIL,e.MENU_ITEMS.SHARE_BRAND],e}();var I=function(){function e(e,t){var n=this;this.storage=e,this.events=t,this.getUser().then(function(e){n.user&&n.events.publish("user:ready",n.user)}).catch(),y.getUrlParam("clear")&&e.clear().then(function(e){return location.replace(location.href.split("?")[0])})}return e.prototype.setUser=function(t){return console.warn("set user"),this.user=t,this.user&&(this.user.expiresIn=Date.now()+(v.ENV.debug?1e3:6048e5),this.events.publish("user:ready",this.user)),this.storage.set(e.KEY_USER,t)},e.prototype.getUser=function(){var t=this;return this.user?Promise.resolve(this.user):this.storage.get(e.KEY_USER).then(function(n){return n&&n.expiresIn<Date.now()?(t.storage.remove(e.KEY_USER),null):(t.user=n,t.user)})},e.prototype.getUserSync=function(){return this.user},e.prototype.get=function(e){return this.storage.get(e)},e.prototype.set=function(e,t){return this.storage.set(e,t)},e.prototype.doOnUserReady=function(e,t){var n=this;void 0===t&&(t="user:ready"),this.getUser().then(function(r){if(n.user=n.user||r,n.user)e(n.user),console.warn("user ready");else{var o=function(r){e(r),n.events.unsubscribe(t,o)};n.events.subscribe(t,o),console.warn("user no ready")}})},e.KEY_USER="user",e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:o.Storage},{type:i.Events}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(o.Storage),t.ɵɵinject(i.Events))},token:e,providedIn:"root"}),e}();var S=function(){function e(e,t,n,r,o,i){this.modal=e,this.popover=t,this.actionSheet=n,this.loadingCtrl=r,this.alertCtrl=o,this.toastCtrl=i}return e.prototype.toastShort=function(e,t){return this.toast({message:e,position:t||"top",duration:2e3})},e.prototype.toast=function(e){return this.toastCtrl.create(e).then(function(e){e.present()})},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:i.ModalController},{type:i.PopoverController},{type:i.ActionSheetController},{type:i.LoadingController},{type:i.AlertController},{type:i.ToastController}]},e.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(i.ModalController),t.ɵɵinject(i.PopoverController),t.ɵɵinject(i.ActionSheetController),t.ɵɵinject(i.LoadingController),t.ɵɵinject(i.AlertController),t.ɵɵinject(i.ToastController))},token:e,providedIn:"root"}),e}();var _=new t.InjectionToken("IonWechatConfig"),v=function(){function n(t,r,o,i){if(n.ENV.debug=t.debug||!1,f.BASE_URL=t.imgBaseUrl||"",I.KEY_USER=t.userKey||"user",y.getUrlParam("vConsole"))new s;e.UI=r,e.IonEvent=i,e.DB=o}return n.forRoot=function(e){return{ngModule:n,providers:[{provide:_,useValue:e}]}},n.ENV={debug:!1},n.decorators=[{type:t.NgModule,args:[{declarations:[],imports:[i.IonicModule,o.IonicStorageModule.forRoot()]}]}],n.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:[_]}]},{type:S},{type:I},{type:i.Events}]},n}();e.CONFIG=_,e.IonWechatModule=v,e.IonWechatPipesModule=m,e.Wechat=y,e.ɵa=l,e.ɵb=p,e.ɵc=d,e.ɵd=f,e.ɵe=S,e.ɵf=I,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ion-wechat.umd.min.js.map