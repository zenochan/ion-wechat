# 微信登录一般流程

- A 检查本地是否有用户信息
- B 如果用户信息不可用，执行 C， 否则结束登录流程(处理 url 参数)
- C 先检查 code: 有 code ->D  , 无 code -> E
- D 用 code 请求登录
- E 跳转认证页面(处理好需要保留的参数)


```ts
// 授权/刷新用户数据
Observable.fromPromise(Data.getUser())
    .flatMap((user: any) => {
      if (user) {
        return API.get<User>('user/refresh')
      } else {
        let url = Wechat.shareUrl({c: Wechat.getUrlParam('c')});
        return Wechat.code({
          appid: ENV.APP_ID,
          component_appid: ENV.COMPONENT_APPID,
          // proxy: 'http://wxc07fd4f3157d0406.wxopen.morma.cn/auth.html',
          redirect_uri: url
        }).flatMap(code => API.get<User>(`auth/:code`, false, {
          code: code,
          user_id: Wechat.getUrlParam('c') || ''
        }))
      }
    })
    .subscribe(user => {
      Data.setUser(user)
    }, e => {
      UI.alert(e, null, () => Wechat.closeWindow())
    });
```
